<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORION SQUID GAMES | MASTER EDITION</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root { --pk: #ff2e63; --gr: #00ff41; --gd: #ffd700; --bk: #050505; --rd: #ff003c; --bl: #08d9d6; }
        
        body {
            background: #000; color: white; font-family: 'Courier New', monospace; margin: 0;
            display: flex; flex-direction: column; align-items: center; padding: 10px;
            min-height: 100vh; overflow-x: hidden; user-select: none; touch-action: manipulation;
        }

        /* EFECTO CRT Y RUIDO */
        body::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; z-index: 999; pointer-events: none; opacity: 0.6;
        }

        .card {
            background: rgba(10, 10, 10, 0.9); border: 1px solid rgba(255, 46, 99, 0.4);
            border-radius: 12px; padding: 25px; width: 100%; max-width: 600px;
            margin-top: 10px; box-sizing: border-box; box-shadow: 0 0 30px rgba(255, 46, 99, 0.1);
            position: relative; z-index: 10;
        }

        .logo { font-size: 2.8rem; letter-spacing: 12px; text-shadow: 0 0 20px var(--pk); text-align: center; cursor: pointer; animation: pulse 2s infinite; margin-bottom: 10px; }
        
        input { width: 100%; padding: 15px; margin-bottom: 15px; background: #111; color: white; border: 1px solid #444; border-radius: 8px; font-size: 1.2rem; text-align: center; text-transform: uppercase; box-sizing: border-box; }
        input:focus { outline: none; border-color: var(--pk); box-shadow: 0 0 15px var(--pk); }

        button { width: 100%; padding: 18px; margin: 8px 0; background: transparent; border: 2px solid var(--pk); color: var(--pk); font-size: 1.1rem; font-weight: 900; cursor: pointer; border-radius: 8px; text-transform: uppercase; transition: 0.1s; box-sizing: border-box; }
        button:active { transform: scale(0.96); background: var(--pk); color: white; }
        
        /* SHAKE EFFECT PARA MUERTE */
        .shake-hard { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-5px, 0, 0); } 20%, 80% { transform: translate3d(5px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-10px, 0, 0); } 40%, 60% { transform: translate3d(10px, 0, 0); } }

        .luz { width: 120px; height: 120px; border-radius: 50%; margin: 20px auto; border: 6px solid #111; transition: 0.1s; }
        .luz-verde { background: var(--gr); box-shadow: 0 0 60px var(--gr); }
        .luz-roja { background: var(--rd); box-shadow: 0 0 60px var(--rd); }

        /* VISTAS */
        .view-dead { background: radial-gradient(circle, #3a0000 0%, #000 100%); border-color: var(--rd); box-shadow: inset 0 0 50px rgba(255,0,0,0.5); }
        .view-vip { background: radial-gradient(circle, #222 0%, #000 100%); border-color: var(--gd); }
        
        #admin-panel { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:10000; display:none; padding:20px; overflow-y:auto; box-sizing:border-box; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

    <audio id="snd-shot" src="https://www.myinstants.com/media/sounds/m1-garand-ping.mp3" preload="auto"></audio>
    <audio id="snd-win" src="https://www.myinstants.com/media/sounds/level-up-sound-effect.mp3" preload="auto"></audio>
    <audio id="snd-siren" src="https://www.myinstants.com/media/sounds/the-purge-siren.mp3" preload="auto"></audio>
    <audio id="snd-tension" src="https://www.myinstants.com/media/sounds/heartbeat-sound-effect-slow.mp3" loop preload="auto"></audio>

    <header>
        <div class="logo">üî∫‚ö™üü¶</div>
        <h1 style="color:var(--pk); text-align:center; margin:0; font-size:1.2rem; letter-spacing:4px;">ORION SQUID GAMES</h1>
    </header>

    <section id="auth-screen" class="card animate__animated animate__fadeIn">
        <h3 style="color:#aaa; text-align:center;">FIRMA EL CONTRATO</h3>
        <p style="color:#666; font-size:0.8rem; text-align:center;">*Al entrar, aceptas encender el audio.</p>
        <input type="text" id="username" placeholder="TU NOMBRE DE MAGO">
        <button onpointerdown="joinGame('PLAYER')" style="background:var(--pk); color:white;">ENTRAR A LA ARENA</button>
        <button onpointerdown="joinGame('SPECTATOR')" style="border-color:var(--gd); color:var(--gd);">MODO ESPECTADOR VIP</button>
    </section>

    <section id="arena-screen" class="card" style="display:none;">
        <div style="display:flex; justify-content:space-between; border-bottom: 1px solid #333; padding-bottom: 10px;">
            <span id="p-number" style="font-size:1.5rem; color:var(--bl); font-weight:bold;">#000</span>
            <span id="p-status" style="color:var(--gr); font-weight:bold; font-size:1.2rem;">‚óè VIVO</span>
        </div>
        
        <h2 id="game-title" style="color:var(--pk); text-align:center; font-size:1.8rem;">CONECTANDO...</h2>
        <p id="game-desc" style="color:#ccc; text-align:center; min-height:40px;"></p>
        
        <div id="game-canvas" style="min-height: 220px; text-align:center;"></div>
    </section>

    <section id="observer-screen" class="card" style="display:none;">
        <h2 id="obs-title" style="color:var(--gd); text-align:center; font-size:2rem;">SAL√ìN VIP</h2>
        <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:10px; text-align:center;">
            <p style="font-size:1.2rem;">TRIBUTOS VIVOS: <span id="stat-alive" style="color:var(--gr); font-size:2rem; font-weight:bold;">0</span></p>
            <p style="font-size:1.2rem;">ELIMINADOS: <span id="stat-dead" style="color:var(--rd); font-size:2rem; font-weight:bold;">0</span></p>
        </div>
        <h3 style="text-align:center; color:var(--pk); margin-top:20px;">JUEGO: <span id="obs-game">...</span></h3>
    </section>

    <section id="admin-panel">
        <h2 style="color:var(--rd); text-align:center;">üëÅÔ∏è PANEL DIVINO</h2>
        
        <div style="background:#111; padding:15px; border-radius:10px; margin-bottom:15px;">
            <h3 style="color:var(--gd); margin-top:0;">EFECTOS GLOBALES (Todos los celulares)</h3>
            <div class="admin-grid">
                <button onpointerdown="fireGlobalSound('snd-siren')" style="border-color:var(--rd); color:var(--rd);">üö® SIRENA PURGA</button>
                <button onpointerdown="fireGlobalSound('snd-tension')" style="border-color:var(--bl); color:var(--bl);">üíì LATIDOS</button>
            </div>
        </div>

        <div style="background:#111; padding:15px; border-radius:10px;">
            <h3 style="color:var(--pk); margin-top:0;">LOS 6 JUEGOS</h3>
            <button onpointerdown="setGame('SALA DE ESPERA')">0. ESPERA / RESET</button>
            <div class="admin-grid">
                <button onpointerdown="setGame('LUZ ROJA')">1. LUZ ROJA</button>
                <button onpointerdown="setGame('DALGONA')">2. DALGONA</button>
                <button onpointerdown="setGame('PUENTE')">3. PUENTE</button>
                <button onpointerdown="setGame('TIPEO')">4. TIPEO</button>
                <button onpointerdown="setGame('CANICAS')">5. CANICAS</button>
                <button onpointerdown="setGame('DUELO')">6. DUELO FINAL</button>
            </div>
        </div>

        <div id="admin-luz" style="display:none; background:rgba(255,0,0,0.2); padding:15px; border-radius:10px; margin-top:15px;">
            <div class="admin-grid">
                <button onpointerdown="setLight('VERDE')" style="background:var(--gr); color:black;">üü¢ VERDE</button>
                <button onpointerdown="setLight('ROJO')" style="background:var(--rd); color:white;">üî¥ ROJO</button>
            </div>
        </div>
        <button onpointerdown="closeAdmin()" style="margin-top:20px; border-color:#444; color:#aaa;">CERRAR PANEL</button>
    </section>

    <script>
        // CONFIG FIREBASE (Rellena si cambias de BD)
        const firebaseConfig = { databaseURL: "https://squid-games-24283-default-rtdb.firebaseio.com/" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        // ESTADO LOCAL ROBUSTO
        let P = { id: localStorage.getItem('o2_id'), role: localStorage.getItem('o2_role'), status: 'ALIVE', prog: 0 };
        let G = { name: "SALA DE ESPERA", light: "ROJO" };
        let roundWon = false;
        let adminClicks = 0;

        // ACTIVAR AUDIO EN MOVILES
        function unlockAudio() {
            ['snd-shot', 'snd-win', 'snd-siren', 'snd-tension'].forEach(id => {
                let s = document.getElementById(id);
                s.volume = 0; s.play().then(()=> { s.pause(); s.currentTime = 0; s.volume = 1; }).catch(e=>{});
            });
        }
        function playSnd(id) { let s = document.getElementById(id); s.currentTime=0; s.play().catch(e=>{}); }
        function stopSnd(id) { let s = document.getElementById(id); s.pause(); s.currentTime=0; }

        // ADMIN SECRETO (7 Clics)
        document.querySelector('.logo').onclick = () => {
            adminClicks++; if(adminClicks >= 7) { document.getElementById('admin-panel').style.display = 'block'; adminClicks=0; }
        };
        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }
        function setGame(n) { db.ref('s/g').set(n); db.ref('s/l').set("ROJO"); document.getElementById('admin-luz').style.display = (n==='LUZ ROJA')?'block':'none'; }
        function setLight(c) { db.ref('s/l').set(c); }
        function fireGlobalSound(snd) { db.ref('s/snd').set({ id: snd, t: Date.now() }); }

        // INGRESO
        function joinGame(role) {
            unlockAudio(); // Truco vital para celulares
            const name = document.getElementById('username').value.trim().toUpperCase();
            if(!name) return;
            
            P.id = "u_" + Date.now(); P.role = role;
            const num = Math.floor(Math.random()*456 + 1).toString().padStart(3,'0');
            localStorage.setItem('o2_id', P.id); localStorage.setItem('o2_role', P.role);
            
            if(role === 'PLAYER') db.ref('p/' + P.id).set({ n: name, num: num, st: "ALIVE" });
            routeUser();
        }

        // ENRUTAMIENTO Y VISTAS
        function routeUser() {
            document.getElementById('auth-screen').style.display = 'none';
            if(P.role === 'SPECTATOR' || P.status === 'DEAD') {
                document.getElementById('arena-screen').style.display = 'none';
                document.getElementById('observer-screen').style.display = 'block';
                
                if(P.status === 'DEAD') {
                    document.getElementById('observer-screen').classList.add('view-dead');
                    document.getElementById('obs-title').innerText = "EL PURGATORIO";
                    document.getElementById('obs-title').style.color = "var(--rd)";
                } else {
                    document.getElementById('observer-screen').classList.add('view-vip');
                }
                listenStats();
            } else {
                document.getElementById('arena-screen').style.display = 'block';
                db.ref('p/' + P.id).once('value', s => { 
                    if(s.exists()) { 
                        document.getElementById('p-number').innerText = "#" + s.val().num; 
                        if(s.val().st === 'DEAD') { P.status = 'DEAD'; routeUser(); }
                    } 
                });
                listenGame();
            }
        }

        // LISTENERS (Optimizado para no bugearse)
        function listenStats() {
            db.ref('s/g').on('value', s => document.getElementById('obs-game').innerText = s.val() || "ESPERA");
            db.ref('p').on('value', s => {
                let a=0, d=0; s.forEach(c => { if(c.val().st === 'ALIVE') a++; else d++; });
                document.getElementById('stat-alive').innerText = a; document.getElementById('stat-dead').innerText = d;
            });
        }

        function listenGame() {
            // Sonidos Globales
            db.ref('s/snd').on('value', s => { if(s.val()) playSnd(s.val().id); });
            
            // Estado del Juego
            db.ref('s').on('value', snap => {
                const data = snap.val(); if(!data) return;
                G.name = data.g; G.light = data.l;
                
                if(window.lastG !== G.name) {
                    roundWon = false; P.prog = 0; window.lastG = G.name;
                    document.getElementById('arena-screen').style.borderColor = "rgba(255, 46, 99, 0.4)";
                }
                renderUI();
            });

            // Muerte Externa
            db.ref('p/' + P.id + '/st').on('value', s => {
                if(s.val() === 'DEAD' && P.status !== 'DEAD') {
                    P.status = 'DEAD'; playSnd('snd-shot');
                    document.body.classList.add('shake-hard'); document.body.style.background = "var(--rd)";
                    setTimeout(() => { document.body.style.background = ""; routeUser(); }, 1500);
                }
            });
        }

        // MOTOR RENDERIZADOR
        function renderUI() {
            if(P.status === 'DEAD') return;
            if(roundWon) return showWin();

            const c = document.getElementById('game-canvas');
            document.getElementById('game-title').innerText = G.name;
            const d = document.getElementById('game-desc');

            if(G.name === "LUZ ROJA") {
                d.innerText = "Meta: 100 Pasos. Luz Verde avanzas, Luz Roja mueres.";
                c.innerHTML = `
                    <div class="luz ${G.light === 'VERDE' ? 'luz-verde' : 'luz-roja'}"></div>
                    <p style="color:var(--gd); font-size:1.5rem; margin:10px 0;">PASOS: ${P.prog}/100</p>
                    <button onpointerdown="actLuz()" style="height:90px; font-size:1.8rem; background:rgba(255,255,255,0.1);">AVANZAR üèÉ</button>`;
            } 
            else if(G.name === "DALGONA") {
                d.innerText = "Meta: Precisi√≥n. Mant√©n presionado EXACTAMENTE 4.0 segundos (3.8 a 4.2).";
                c.innerHTML = `<button id="b-dalgona" onpointerdown="sDal()" onpointerup="eDal()" onpointerleave="eDal()" style="height:150px; font-size:1.5rem; border-color:var(--gd); color:var(--gd); margin-top:20px;">üëâ MANTENER üëà</button>`;
            }
            else if(G.name === "PUENTE") {
                d.innerText = `Meta: Cruza 5 cristales (50% de Letalidad).\nCRISTAL ACTUAL: ${P.prog}/5`;
                c.innerHTML = `<div class="admin-grid" style="margin-top:30px;">
                    <button onpointerdown="actPte()" style="height:120px; border-color:var(--bl); color:var(--bl);">IZQUIERDA</button>
                    <button onpointerdown="actPte()" style="height:120px; border-color:var(--bl); color:var(--bl);">DERECHA</button>
                </div>`;
            }
            else if(G.name === "TIPEO") {
                d.innerText = "Meta: Tipea el contrahechizo a la perfecci√≥n.";
                c.innerHTML = `<h3 style="color:var(--bl); font-size:2rem; letter-spacing:3px;">PROTEGO MAXIMA</h3>
                    <input type="text" id="i-spell" placeholder="Escribe aqu√≠..." autocomplete="off">
                    <button onpointerdown="actTip()">LANZAR</button>`;
            }
            else if(G.name === "CANICAS") {
                d.innerText = `Meta: Adivina Par o Impar contra el Guardia. 3 Intentos.\nINTENTO: ${P.prog}/3`;
                c.innerHTML = `<div class="admin-grid" style="margin-top:20px;">
                    <button onpointerdown="actCan(0)" style="height:100px;">PARES</button>
                    <button onpointerdown="actCan(1)" style="height:100px;">NONES</button>
                </div>`;
            }
            else if(G.name === "DUELO") {
                d.innerText = "Meta: Sobrevive al Duelo (Piedra/Papel/Tijera M√°gico).";
                c.innerHTML = `
                    <button onpointerdown="winRound()" style="border-color:var(--rd); color:var(--rd);">üî• EXPELLIARMUS (Ataque)</button>
                    <button onpointerdown="winRound()" style="border-color:var(--bl); color:var(--bl);">üõ°Ô∏è PROTEGO (Defensa)</button>
                    <button onpointerdown="winRound()" style="border-color:var(--gr); color:var(--gr);">üêç DESMAIUS (Sigilo)</button>`;
            }
            else {
                d.innerText = "Descansa, mago. Atento a las √≥rdenes del Guardi√°n.";
                c.innerHTML = `<div class="animate__animated animate__pulse animate__infinite" style="font-size:5rem; margin-top:20px;">‚è≥</div>`;
            }
        }

        // ACCIONES DE JUEGO (L√≥gica Anti-Bug)
        function actLuz() {
            if(G.light === 'ROJO') return die();
            P.prog += 2; renderUI(); if(P.prog >= 100) winRound();
        }

        let tDal;
        function sDal() { tDal = Date.now(); document.getElementById('b-dalgona').style.background="var(--gd)"; document.getElementById('b-dalgona').style.color="black"; }
        function eDal() {
            if(!tDal) return; let diff = (Date.now() - tDal)/1000; tDal = null;
            if(diff >= 3.8 && diff <= 4.2) winRound(); else die();
        }

        function actPte() {
            if(Math.random() < 0.5) die(); else { P.prog++; if(P.prog>=5) winRound(); else renderUI(); }
        }

        function actTip() {
            if(document.getElementById('i-spell').value.trim().toUpperCase() === "PROTEGO MAXIMA") winRound(); else die();
        }

        function actCan(guess) {
            let secret = Math.floor(Math.random()*10); // Par(0) o Impar(1)
            if(secret%2 !== guess) return die(); // Fallaste
            P.prog++; if(P.prog>=3) winRound(); else renderUI();
        }

        // RESOLUCI√ìN DE VIDA O MUERTE
        function die() { db.ref('p/' + P.id).update({ st: "DEAD" }); }
        
        function winRound() {
            roundWon = true; playSnd('snd-win');
            document.getElementById('arena-screen').style.borderColor = "var(--gd)";
            document.getElementById('game-desc').innerText = "";
            document.getElementById('game-canvas').innerHTML = `
                <h1 class="animate__animated animate__tada" style="color:var(--gd); font-size:3.5rem; text-shadow:0 0 40px var(--gd); margin-top:20px;">CALIFICADO</h1>
                <p style="color:#aaa; font-size:1.2rem;">Objetivo cumplido. Est√°s a salvo... por ahora.</p>`;
        }

        window.onload = () => { if(P.id) routeUser(); };
    </script>
</body>
</html>
