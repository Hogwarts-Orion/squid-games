<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORION SQUID GAMES | MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --pk: #ff2e63; --gr: #00ff41; --gd: #ffd700; --bk: #050505; --rd: #ff003c; --bl: #08d9d6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bk); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .card { background: rgba(20,20,20,0.95); border: 1px solid #333; border-radius: 12px; padding: 20px; width: 100%; max-width: 480px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); text-align: center; }
        .logo { font-size: 1.8rem; letter-spacing: 8px; text-shadow: 0 0 10px var(--pk); margin-bottom: 15px; font-weight: 900; }
        .btn-reset { position: fixed; right: 15px; top: 15px; background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; z-index: 10000; cursor: pointer; }
        input { width: 100%; padding: 14px; margin-bottom: 10px; background: #000; color: white; border: 1px solid #444; border-radius: 8px; text-align: center; }
        button { width: 100%; padding: 14px; margin: 5px 0; background: transparent; border: 2px solid var(--pk); color: var(--pk); font-weight: bold; border-radius: 8px; text-transform: uppercase; cursor: pointer; }
        button:active { background: var(--pk); color: white; }
        .luz { width: 70px; height: 70px; border-radius: 50%; margin: 15px auto; border: 4px solid #111; }
        .luz-verde { background: var(--gr); box-shadow: 0 0 30px var(--gr); }
        .luz-roja { background: var(--rd); box-shadow: 0 0 30px var(--rd); }
        .view { display: none; }
        .active-view { display: block !important; }
        #dalgona-btn { height: 120px; font-size: 1.2rem; transition: background 0.1s; touch-action: none; }
        #dalgona-btn.pressing { background: var(--gd); color: black; border-color: var(--gd); }
    </style>
</head>
<body>

    <div class="btn-reset" onclick="localStorage.clear(); location.reload();">ðŸ”„</div>
    <div class="logo">ðŸ”ºâšªðŸŸ¦</div>

    <section id="view-login" class="card view active-view">
        <input type="text" id="username" placeholder="TU NOMBRE">
        <button onclick="access('PLAYER')" style="background: var(--pk); color:white;">ENTRAR A LA ARENA</button>
        <div style="margin-top:20px; border-top: 1px solid #333; padding-top:15px;">
            <input type="password" id="admin-pass" placeholder="PASSWORD">
            <button onclick="access('ADMIN')" style="border-color: var(--rd); color: var(--rd);">PANEL ADMIN</button>
        </div>
    </section>

    <section id="view-player" class="card view">
        <h2 id="p-game-title">ESPERA</h2>
        <div id="p-canvas"></div>
    </section>

    <section id="view-admin" class="card view">
        <h3>MANDO GLOBAL</h3>
        <div id="admin-luz-ctrl" style="display:none; margin-bottom:10px;">
            <button onclick="dbSet('state/light', 'VERDE')" style="color:var(--gr)">VERDE</button>
            <button onclick="dbSet('state/light', 'ROJO')" style="color:var(--rd)">ROJA</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button onclick="adminGame('LUZ ROJA')">L.ROJA</button>
            <button onclick="adminGame('DALGONA')">DALGONA</button>
            <button onclick="adminGame('TIPEO')">TIPEO</button>
            <button onclick="adminGame('ESPERA')">RESET</button>
        </div>
    </section>

    <script>
        const fbCfg = { databaseURL: "https://squid-games-24283-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(fbCfg);
        const db = firebase.database();

        let U = { id: localStorage.getItem('os_id'), role: localStorage.getItem('os_role'), st: 'ALIVE', q: false };
        let td; // Timer para Dalgona

        function access(role) {
            const name = document.getElementById('username').value.trim().toUpperCase() || "MAGO";
            if(role === 'ADMIN') {
                if(document.getElementById('admin-pass').value !== "SquidGamesOrion15") return alert("Error");
                U.role = 'ADMIN'; localStorage.setItem('os_role', 'ADMIN');
            } else {
                U.id = "u" + Date.now(); U.role = role;
                localStorage.setItem('os_id', U.id); localStorage.setItem('os_role', role);
                db.ref('players/'+U.id).set({ n: name, st: "ALIVE", q: false });
            }
            route();
        }

        function route() {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            if(U.role === 'ADMIN') { document.getElementById('view-admin').classList.add('active-view'); initAdmin(); }
            else { document.getElementById('view-player').classList.add('active-view'); initPlayer(); }
        }

        function initAdmin() {
            db.ref('state/game').on('value', s => { 
                let g = s.val() || 'ESPERA';
                document.getElementById('admin-luz-ctrl').style.display = (g === 'LUZ ROJA') ? 'block' : 'none';
            });
        }

        function adminGame(g) { db.ref('state').update({ game: g, light: 'ROJO' }); }
        function dbSet(p, v) { db.ref(p).set(v); }

        function initPlayer() {
            db.ref('state').on('value', snap => {
                const s = snap.val() || {game:'ESPERA', light:'ROJO'};
                render(s.game, s.light);
            });
            db.ref('players/'+U.id+'/st').on('value', s => { if(s.val()==='DEAD') { alert("ELIMINADO"); location.reload(); } });
            db.ref('players/'+U.id+'/q').on('value', s => { if(s.val()===true) U.q = true; });
        }

        function render(g, l) {
            const v = document.getElementById('p-canvas');
            document.getElementById('p-game-title').innerText = g;
            if(U.q) { v.innerHTML = "<h1>CALIFICADO</h1>"; return; }

            if(g === 'LUZ ROJA') {
                v.innerHTML = `<div class="luz ${l==='VERDE'?'luz-verde':'luz-roja'}"></div><button onclick="moveL('${l}')">AVANZAR</button>`;
            } else if(g === 'DALGONA') {
                v.innerHTML = `<button id="dalgona-btn">MANTENER PRESIONADO 4 SEGUNDOS</button>`;
                const btn = document.getElementById('dalgona-btn');
                // IMPORTANTE: Eventos pointer para que funcione en mÃ³viles
                btn.onpointerdown = sD;
                btn.onpointerup = eD;
                btn.onpointerleave = eD;
            } else if(g === 'TIPEO') {
                v.innerHTML = `<input id="sp" placeholder="ESCRIBE EL HECHIZO"><button onclick="checkT()">LANZAR</button>`;
            } else { v.innerHTML = "ESPERANDO..."; }
        }

        function sD(e) { 
            e.preventDefault();
            td = Date.now(); 
            document.getElementById('dalgona-btn').classList.add('pressing');
        }

        function eD(e) { 
            if(!td) return;
            let diff = (Date.now() - td) / 1000;
            td = null;
            document.getElementById('dalgona-btn').classList.remove('pressing');
            if(diff >= 3.8 && diff <= 4.2) { db.ref('players/'+U.id).update({q:true}); } 
            else { db.ref('players/'+U.id).update({st:'DEAD'}); }
        }

        function moveL(l) { if(l === 'ROJO') db.ref('players/'+U.id).update({st:'DEAD'}); }
        function checkT() { if(document.getElementById('sp').value.toUpperCase()==="EXPECTO PATRONUM") db.ref('players/'+U.id).update({q:true}); else db.ref('players/'+U.id).update({st:'DEAD'}); }

        if(U.role) route();
    </script>
</body>
</html>
