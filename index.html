<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORION SQUID GAMES | MASTER EDITION</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --pk: #ff2e63; --gr: #00ff41; --gd: #ffd700; --bk: #050505; --rd: #ff003c; --bl: #08d9d6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bk); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; min-height: 100vh; overflow-x: hidden; user-select: none; touch-action: manipulation; }

        .card { background: rgba(18,18,18,0.98); border: 1px solid #333; border-radius: 12px; padding: 20px; margin-bottom: 10px; width: 100%; max-width: 480px; margin-left: auto; margin-right: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.8); text-align: center; }
        .logo { font-size: 1.8rem; letter-spacing: 8px; text-shadow: 0 0 10px var(--pk); color: white; margin-bottom: 15px; font-weight: 900; }
        
        .btn-reset { position: fixed; right: 10px; top: 10px; font-size: 1.2rem; cursor: pointer; background: rgba(255,255,255,0.15); border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; border: 1px solid #555; z-index: 10000; }

        input { width: 100%; padding: 14px; margin-bottom: 12px; background: #000; color: white; border: 1px solid #444; border-radius: 8px; font-size: 1.1rem; text-align: center; text-transform: uppercase; }
        input:focus { outline: none; border-color: var(--pk); box-shadow: 0 0 10px var(--pk); }

        button { width: 100%; padding: 15px; margin: 5px 0; background: transparent; border: 2px solid var(--pk); color: var(--pk); font-size: 1rem; font-weight: bold; cursor: pointer; border-radius: 8px; text-transform: uppercase; transition: 0.1s; }
        button:active { background: var(--pk); color: white; transform: scale(0.97); }
        .btn-fill { background: var(--pk); color: white; }
        .btn-gold { border-color: var(--gd); color: var(--gd); }
        .btn-danger { border-color: var(--rd); background: rgba(255,0,0,0.1); color: var(--rd); }
        .btn-success { border-color: var(--gr); background: rgba(0,255,0,0.1); color: var(--gr); }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .grid-3 button { padding: 12px 2px; font-size: 0.75rem; border-width: 1px; }

        .stats-row { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-family: monospace; font-size: 1.1rem; border: 1px solid #333; }
        
        .luz { width: 85px; height: 85px; border-radius: 50%; margin: 20px auto; border: 5px solid #111; transition: 0.1s; }
        .luz-verde { background: var(--gr); box-shadow: 0 0 40px var(--gr); }
        .luz-roja { background: var(--rd); box-shadow: 0 0 40px var(--rd); }
        .bar-bg { width: 100%; height: 20px; background: #222; border-radius: 10px; overflow: hidden; margin: 15px 0; border: 1px solid #333; }
        .bar-fill { height: 100%; background: var(--gr); width: 0%; transition: 0.2s; }

        .dead-screen { background: radial-gradient(circle, #4a0000 0%, #000 100%) !important; border-color: var(--rd) !important; }
        .win-screen { border-color: var(--gd) !important; box-shadow: 0 0 30px rgba(255,215,0,0.3); }

        .view { display: none; }
        .active-view { display: block !important; }

        #toast-container { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); z-index: 20000; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: #111; border: 1px solid var(--bl); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,1); animation: slideIn 0.3s forwards; font-weight: bold; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        #btn-dalgona.pressing, #btn-caliz.pressing { background: var(--gd); color: black; border-color: var(--gd); box-shadow: 0 0 20px var(--gd); }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <div class="btn-reset" onclick="hardReset()">üîÑ</div>

    <audio id="snd-shot" src="https://www.myinstants.com/media/sounds/m1-garand-ping.mp3" preload="auto"></audio>
    <audio id="snd-win" src="https://www.myinstants.com/media/sounds/level-up-sound-effect.mp3" preload="auto"></audio>
    <audio id="snd-siren" src="https://www.myinstants.com/media/sounds/the-purge-siren.mp3" preload="auto"></audio>

    <div class="logo">üî∫‚ö™üü¶</div>

    <section id="view-login" class="card view active-view">
        <h3 style="margin-top:0;">SELECCIONA ROL</h3>
        <input type="text" id="username" placeholder="TU NOMBRE">
        <button class="btn-fill" onclick="login('PLAYER')">ENTRAR A ARENA</button>
        <button class="btn-gold" onclick="login('VIP')">GRADA VIP</button>
        <div style="margin-top:20px; border-top: 1px solid #333; padding-top:15px;">
            <input type="password" id="admin-pass" placeholder="PASSWORD ADMIN">
            <button class="btn-danger" onclick="login('ADMIN')">MODO GUARDI√ÅN</button>
        </div>
    </section>

    <section id="view-player" class="card view">
        <div class="stats-row">
            <span id="p-tag" style="color:var(--bl);">#000</span>
            <span id="p-status" style="color:var(--gr); font-weight:bold;">VIVO</span>
        </div>
        <h2 id="p-game-title" style="color:var(--pk);">ESPERA</h2>
        <p id="p-game-desc" style="color:#aaa; font-size:0.9rem; min-height:40px;"></p>
        <div id="p-canvas" style="min-height: 200px;"></div>
    </section>

    <section id="view-admin" class="card view" style="border-color:var(--rd);">
        <h3 style="margin-top:0; color:var(--rd);">üõ°Ô∏è MANDO GLOBAL</h3>
        <div class="stats-row">
            <span>V: <b id="a-alive">0</b></span>
            <span>ACTUAL: <b id="a-game">...</b></span>
            <span>M: <b id="a-dead">0</b></span>
        </div>
        <div id="admin-luz-ctrl" style="display:none; margin-bottom:15px;" class="grid-2">
            <button class="btn-success" onclick="dbSet('state/light', 'VERDE')">VERDE</button>
            <button class="btn-danger" onclick="dbSet('state/light', 'ROJO')">ROJA</button>
        </div>
        <div class="grid-3">
            <button onclick="setGame('ESPERA')">RESET</button>
            <button onclick="setGame('LUZ ROJA')">L.ROJA</button>
            <button onclick="setGame('DALGONA')">DALGONA</button>
            <button onclick="setGame('PUENTE')">PUENTE</button>
            <button onclick="setGame('TIPEO')">TIPEO</button>
            <button onclick="setGame('CANICAS')">CANICAS</button>
            <button onclick="setGame('RULETA')">RULETA</button>
            <button onclick="setGame('REFLEJOS')">REFLEJOS</button>
            <button onclick="setGame('C√ÅLIZ')">C√ÅLIZ</button>
        </div>
        <div class="grid-2" style="margin-top:15px;">
            <button class="btn-danger" onclick="killSlow()">ELIMINAR LENTOS</button>
            <button class="btn-success" onclick="reviveAll()">REVIVIR TODOS</button>
        </div>
        <div class="grid-2">
            <button onclick="fireSound('snd-siren')">üö® SIRENA</button>
            <button onclick="fireSound('snd-shot')">üî´ DISPARO</button>
        </div>
    </section>

    <section id="view-vip" class="card view">
        <h2 id="v-title" style="color:var(--gd);">PANEL VIP</h2>
        <div class="stats-row" style="text-align:center; display:block; padding:20px;">
            VIVOS: <span id="v-alive" style="color:var(--gr); font-size:1.5rem;">0</span> | 
            MUERTOS: <span id="v-dead" style="color:var(--rd); font-size:1.5rem;">0</span>
        </div>
        <p style="text-align:center;">JUEGO ACTUAL: <span id="v-game" style="color:white; font-weight:bold;">...</span></p>
    </section>

    <script>
        const config = { databaseURL: "https://squid-games-24283-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(config);
        const db = firebase.database();

        let P = { id: localStorage.getItem('os_id'), role: localStorage.getItem('os_role'), st: 'ALIVE', prog: 0, qual: false };
        let G = { name: "ESPERA", light: "ROJO" };

        function notify(m, type="info") {
            const c = document.getElementById('toast-container');
            const e = document.createElement('div'); e.className = 'toast'; e.innerText = m;
            c.appendChild(e); setTimeout(() => e.remove(), 2500);
        }

        function hardReset() { localStorage.clear(); location.reload(); }
        function switchView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view')); document.getElementById(id).classList.add('active-view'); }
        function playS(id) { let s = document.getElementById(id); s.currentTime=0; s.play().catch(()=>{}); }
        function unlockAudio() { ['snd-shot', 'snd-win', 'snd-siren'].forEach(id => { let s = document.getElementById(id); s.volume=0; s.play().then(()=>{s.pause(); s.currentTime=0; s.volume=1;}).catch(()=>{}); }); }

        function login(role) {
            const name = document.getElementById('username').value.trim().toUpperCase() || "MAGO";
            if(role === 'ADMIN') {
                if(document.getElementById('admin-pass').value !== "SquidGamesOrion15") return notify("‚ùå PASSWORD INCORRECTO");
                P.role = 'ADMIN'; localStorage.setItem('os_role', 'ADMIN');
            } else {
                if(role === 'PLAYER' && name === "MAGO") return notify("‚ö†Ô∏è INGRESA TU NOMBRE");
                unlockAudio();
                P.id = "u" + Date.now(); P.role = role; P.st = "ALIVE";
                localStorage.setItem('os_id', P.id); localStorage.setItem('os_role', role);
                if(role === 'PLAYER') db.ref('players/'+P.id).set({ n: name, st: "ALIVE", q: false, num: Math.floor(Math.random()*400+1) });
            }
            route();
        }

        function route() {
            if(!P.role) return switchView('view-login');
            if(P.role === 'ADMIN') { switchView('view-admin'); initAdmin(); return; }
            if(P.role === 'VIP' || P.st === 'DEAD') { 
                switchView('view-vip'); 
                if(P.st === 'DEAD') { document.getElementById('view-vip').classList.add('dead-screen'); document.getElementById('v-title').innerText = "PURGATORIO"; }
                initVIP(); return; 
            }
            switchView('view-player'); initPlayer();
        }

        // ADMIN
        function initAdmin() {
            db.ref('state/game').on('value', s => { 
                G.name = s.val() || 'ESPERA'; document.getElementById('a-game').innerText = G.name;
                document.getElementById('admin-luz-ctrl').style.display = (G.name === 'LUZ ROJA') ? 'grid' : 'none';
            });
            db.ref('players').on('value', s => {
                let a=0, d=0; s.forEach(c => { if(c.val().st === 'ALIVE') a++; else d++; });
                document.getElementById('a-alive').innerText = a; document.getElementById('a-dead').innerText = d;
            });
        }
        function setGame(g) { db.ref('state').update({ game: g, light: 'ROJO' }); notify("üéÆ JUEGO: " + g); }
        function dbSet(p, v) { db.ref(p).set(v); }
        function reviveAll() { db.ref('players').once('value', s => s.forEach(c => db.ref('players/'+c.key+'/st').set('ALIVE'))); notify("‚ú® TODOS REVIVIDOS"); }
        function killSlow() { db.ref('players').once('value', s => s.forEach(c => { if(c.val().st==='ALIVE' && !c.val().q) db.ref('players/'+c.key+'/st').set('DEAD'); })); notify("‚ò†Ô∏è LENTOS ELIMINADOS"); }
        function fireSound(id) { db.ref('state/snd').set({ id: id, t: Date.now() }); }

        // VIP
        function initVIP() {
            db.ref('state/game').on('value', s => document.getElementById('v-game').innerText = s.val());
            db.ref('players').on('value', s => {
                let a=0, d=0; s.forEach(c => { if(c.val().st === 'ALIVE') a++; else d++; });
                document.getElementById('v-alive').innerText = a; document.getElementById('v-dead').innerText = d;
            });
        }

        // PLAYER
        function initPlayer() {
            db.ref('state/snd').on('value', s => { if(s.val()) playS(s.val().id); });
            db.ref('state').on('value', snap => {
                const s = snap.val() || {game:'ESPERA', light:'ROJO'};
                if(window.lg !== s.game) { P.prog = 0; P.qual = false; window.lg = s.game; db.ref('players/'+P.id+'/q').set(false); clearTimeout(window.refTimer); }
                G.name = s.game; G.light = s.light;
                renderUI();
            });
            db.ref('players/'+P.id+'/st').on('value', s => { if(s.val()==='DEAD' && P.st !== 'DEAD') { P.st='DEAD'; playS('snd-shot'); route(); } });
        }

        function renderUI() {
            if(P.st === 'DEAD') return;
            if(P.qual) return document.getElementById('p-canvas').innerHTML = "<h1 style='color:var(--gd); margin-top:40px;'>CALIFICADO</h1>";
            
            const v = document.getElementById('p-canvas');
            const desc = document.getElementById('p-game-desc');
            document.getElementById('p-game-title').innerText = G.name;

            switch(G.name) {
                case 'LUZ ROJA':
                    desc.innerText = "Avanza en verde. Muere en rojo.";
                    v.innerHTML = `<div class="luz ${G.light==='VERDE'?'luz-verde':'luz-roja'}"></div><div class="bar-bg"><div class="bar-fill" style="width:${P.prog}%"></div></div><button onpointerdown="actLuz()">AVANZAR</button>`;
                    break;
                case 'DALGONA':
                    desc.innerText = "Mant√©n presionado entre 3.8s y 4.2s.";
                    v.innerHTML = `<button id="btn-dalgona" style="height:120px; margin-top:20px; touch-action:none;">üëâ MANTENER üëà</button>`;
                    const bD = document.getElementById('btn-dalgona'); bD.onpointerdown = sDal; bD.onpointerup = eDal; bD.onpointerleave = eDal;
                    break;
                case 'PUENTE':
                    desc.innerText = `Llega al final (${P.prog}/5). 50% de morir.`;
                    v.innerHTML = `<div class="grid-2" style="margin-top:20px;"><button onpointerdown="actPte()">IZQ</button><button onpointerdown="actPte()">DER</button></div>`;
                    break;
                case 'TIPEO':
                    desc.innerText = "Escribe: EXPECTO PATRONUM";
                    v.innerHTML = `<input id="i-sp" autocomplete="off" style="margin-top:10px;"><button onclick="actTip()">LANZAR</button>`;
                    break;
                case 'CANICAS':
                    desc.innerText = `Adivina Par(0) o Impar(1). 3 aciertos (${P.prog}/3).`;
                    v.innerHTML = `<div class="grid-2" style="margin-top:20px;"><button onpointerdown="actCan(0)">PAR</button><button onpointerdown="actCan(1)">NONES</button></div>`;
                    break;
                case 'RULETA':
                    desc.innerText = "Gatilla 5 veces. 16% de morir.";
                    v.innerHTML = `<button class="btn-danger" onpointerdown="actRul()" style="height:100px; margin-top:20px;">üî´ DISPARAR</button>`;
                    break;
                case 'REFLEJOS':
                    desc.innerText = "Toca el escudo r√°pido.";
                    v.innerHTML = `<button id="btn-ref" onclick="win()" style="display:none; height:100px; background:var(--bl); color:black; margin-top:20px;">üõ°Ô∏è ESCUDO</button><p id="ref-w" style="margin-top:40px; font-weight:bold;">ATENTO...</p>`;
                    startRef();
                    break;
                case 'C√ÅLIZ':
                    desc.innerText = "No sueltes hasta el final.";
                    v.innerHTML = `<button id="btn-caliz" style="height:120px; margin-top:20px; touch-action:none;">üèÜ SOSTENER</button>`;
                    const bC = document.getElementById('btn-caliz'); bC.onpointerdown = sCal; bC.onpointerup = eCal; bC.onpointerleave = eCal;
                    break;
                default:
                    desc.innerText = "Espera √≥rdenes.";
                    v.innerHTML = "<h3>SALA DE ESPERA...</h3>";
            }
        }

        // L√ìGICAS
        function actLuz() { if(G.light==='ROJO') die(); else { P.prog+=5; if(P.prog>=100) win(); else renderUI(); } }
        let tD; function sDal(e) { e.preventDefault(); tD=Date.now(); document.getElementById('btn-dalgona').classList.add('pressing'); }
        function eDal() { if(!tD) return; let df=(Date.now()-tD)/1000; tD=null; document.getElementById('btn-dalgona').classList.remove('pressing'); if(df>=3.8 && df<=4.2) win(); else die(); }
        function actPte() { if(Math.random()<0.5) die(); else { P.prog++; if(P.prog>=5) win(); else renderUI(); } }
        function actTip() { if(document.getElementById('i-sp').value.trim().toUpperCase()==="EXPECTO PATRONUM") win(); else die(); }
        function actCan(g) { let s=Math.floor(Math.random()*10); if(s%2!==g) return die(); P.prog++; if(P.prog>=3) win(); else renderUI(); }
        function actRul() { if(Math.random()<0.16) die(); else { P.prog++; if(P.prog>=5) win(); else renderUI(); } }
        function startRef() { setTimeout(() => { if(G.name!=='REFLEJOS' || P.st==='DEAD' || P.qual) return; document.getElementById('ref-w').style.display='none'; document.getElementById('btn-ref').style.display='block'; window.refTimer = setTimeout(() => { if(!P.qual) die(); }, 1100); }, Math.random()*3000+2000); }
        let hc=false; function sCal(e) { e.preventDefault(); hc=true; document.getElementById('btn-caliz').classList.add('pressing'); }
        function eCal() { if(hc && G.name==='C√ÅLIZ') die(); hc=false; }
        function die() { db.ref('players/'+P.id).update({st:'DEAD'}); }
        function win() { P.qual=true; db.ref('players/'+P.id).update({q:true}); playS('snd-win'); renderUI(); }

        window.onload = route;
    </script>
</body>
</html>
