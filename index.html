<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORION SQUID GAMES | MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --pk: #ff2e63; --gr: #00ff41; --gd: #ffd700; --bk: #050505; --rd: #ff003c; --bl: #08d9d6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bk); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; min-height: 100vh; overflow-x: hidden; touch-action: manipulation; }
        .card { background: rgba(20,20,20,0.95); border: 1px solid #333; border-radius: 12px; padding: 15px; margin: auto; width: 100%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .logo { font-size: 1.8rem; letter-spacing: 8px; text-shadow: 0 0 10px var(--pk); font-weight: 900; text-align: center; margin-bottom: 15px; }
        .btn-reset { position: fixed; right: 10px; top: 10px; font-size: 1.2rem; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border: 1px solid #444; z-index: 1000; }
        button { width: 100%; padding: 14px; margin: 4px 0; background: transparent; border: 2px solid var(--pk); color: var(--pk); font-weight: bold; border-radius: 8px; text-transform: uppercase; cursor: pointer; }
        button:active { background: var(--pk); color: white; }
        .stats-row { display: flex; justify-content: space-between; background: #111; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; font-family: monospace; }
        .bridge-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .tile { height: 60px; background: rgba(255,255,255,0.05); border: 2px solid #444; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; }
        .tile.safe { border-color: var(--gr); background: rgba(0,255,0,0.15); color: var(--gr); }
        .tile.broken { border-color: var(--rd); background: rgba(255,0,0,0.15); color: var(--rd); }
        .tile.admin-hint { border-style: dashed; border-color: var(--gd); color: var(--gd); }
        .view { display: none; }
        .active-view { display: block !important; }
    </style>
</head>
<body>

    <div class="btn-reset" onclick="localStorage.clear(); location.reload();">üîÑ</div>
    <div class="logo">üî∫‚ö™üü¶</div>

    <section id="view-login" class="card view active-view">
        <input type="text" id="username" placeholder="NOMBRE" style="width:100%; padding:14px; margin-bottom:12px; background:#000; color:white; border:1px solid #444; border-radius:8px;">
        <select id="user-house" style="width:100%; padding:14px; margin-bottom:12px; background:#000; color:white; border:1px solid #444; border-radius:8px;">
            <option value="Gryffindor">GRYFFINDOR</option>
            <option value="Slytherin">SLYTHERIN</option>
            <option value="Ravenclaw">RAVENCLAW</option>
            <option value="Hufflepuff">HUFFLEPUFF</option>
        </select>
        <button onclick="access('PLAYER')" style="background:var(--pk); color:white;">ENTRAR</button>
        <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <input type="password" id="admin-pass" placeholder="PASSWORD ADMIN" style="width:100%; padding:12px; margin-bottom:10px; background:#000; color:white; border:1px solid #444; border-radius:8px;">
            <button onclick="access('ADMIN')" style="border-color:var(--rd); color:var(--rd);">MODO GUARDI√ÅN</button>
        </div>
    </section>

    <section id="view-player" class="card view">
        <div class="stats-row"><span id="p-tag">#000</span><span id="p-house">...</span><span id="p-status">VIVO</span></div>
        <h2 id="p-game-title" style="color:var(--pk); text-align:center;">JUEGO</h2>
        <div id="p-canvas"></div>
    </section>

    <section id="view-admin" class="card view">
        <h3 style="color:var(--rd); text-align:center;">üõ°Ô∏è MANDO GLOBAL</h3>
        <div class="stats-row"><span>V: <b id="a-alive">0</b></span><span>M: <b id="a-dead">0</b></span></div>
        <div id="admin-bridge-preview" style="display:none; font-size:0.7rem; color:var(--gd); margin-bottom:10px;"></div>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
            <button onclick="adminGame('ESPERA')">RESET</button>
            <button onclick="adminGame('LUZ ROJA')">L.ROJA</button>
            <button onclick="adminGame('PUENTE')">PUENTE</button>
            <button onclick="adminGame('DALGONA')">DALGONA</button>
            <button onclick="adminGame('TIPEO')">TIPEO</button>
            <button onclick="adminGame('RULETA')">RULETA</button>
        </div>
        <button onclick="reviveAll()" style="margin-top:10px; border-color:var(--gr); color:var(--gr);">REVIVIR TODOS</button>
    </section>

    <script>
        const fbCfg = { databaseURL: "https://squid-games-24283-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(fbCfg);
        const db = firebase.database();

        let U = { id: localStorage.getItem('os_id'), role: localStorage.getItem('os_role'), st: 'ALIVE', prog: 0, q: false };
        let currentBridgeMap = []; // El camino secreto
        let bridgeVisuals = [];   // Lo que ven todos

        function access(role) {
            if(role === 'ADMIN') {
                if(document.getElementById('admin-pass').value !== "SquidGamesOrion15") return alert("Error");
                U.role = 'ADMIN'; localStorage.setItem('os_role', 'ADMIN');
            } else {
                U.id = "u" + Date.now(); U.role = role;
                localStorage.setItem('os_id', U.id); localStorage.setItem('os_role', role);
                db.ref('players/'+U.id).set({ n: document.getElementById('username').value, h: document.getElementById('user-house').value, st: "ALIVE", q: false, num: Math.floor(Math.random()*456+1) });
            }
            route();
        }

        function route() {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            if(U.role === 'ADMIN') { document.getElementById('view-admin').classList.add('active-view'); initAdmin(); }
            else { document.getElementById('view-player').classList.add('active-view'); initPlayer(); }
        }

        function initAdmin() {
            db.ref('state/game').on('value', s => { 
                let g = s.val() || 'ESPERA'; 
                document.getElementById('a-game-display')?.remove();
                if(g === 'PUENTE') document.getElementById('admin-bridge-preview').style.display = 'block';
            });
            db.ref('bridge_map').on('value', s => {
                currentBridgeMap = s.val() || [];
                document.getElementById('admin-bridge-preview').innerText = "RUTA SECRETA: " + currentBridgeMap.map(m => m === 0 ? "IZQ" : "DER").join(" > ");
            });
            db.ref('players').on('value', s => {
                let a=0, d=0; s.forEach(c => { if(c.val().st === 'ALIVE') a++; else d++; });
                document.getElementById('a-alive').innerText = a; document.getElementById('a-dead').innerText = d;
            });
        }

        function initPlayer() {
            db.ref('state/game').on('value', g => {
                if(window.lg !== g.val()) { U.prog = 0; U.q = false; window.lg = g.val(); }
                render(g.val());
            });
            db.ref('bridge_map').on('value', s => currentBridgeMap = s.val() || []);
            db.ref('bridge_visuals').on('value', s => { bridgeVisuals = s.val() || []; if(window.lg === 'PUENTE') render('PUENTE'); });
            db.ref('players/'+U.id).on('value', s => {
                if(!s.val()) return;
                U.st = s.val().st;
                document.getElementById('p-tag').innerText = "#" + s.val().num;
                document.getElementById('p-house').innerText = s.val().h;
                if(U.st === 'DEAD') { document.getElementById('p-status').innerText = "MUERTO"; document.getElementById('p-status').style.color = "var(--rd)"; }
            });
        }

        function render(g) {
            const v = document.getElementById('p-canvas');
            document.getElementById('p-game-title').innerText = g;
            if(U.st === 'DEAD') { v.innerHTML = "<h2 style='color:var(--rd)'>ELIMINADO</h2>"; return; }
            if(U.q) { v.innerHTML = "<h2 style='color:var(--gd)'>CALIFICADO</h2>"; return; }

            if(g === 'PUENTE') {
                v.innerHTML = `<p>PASO: ${U.prog}/12</p><div class="bridge-grid" id="bridge"></div>`;
                const b = document.getElementById('bridge');
                for(let i=0; i<2; i++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    let history = bridgeVisuals.find(h => h.step === U.prog && h.side === i);
                    if(history) {
                        tile.className += history.broken ? ' broken' : ' safe';
                        tile.innerText = history.broken ? 'ROT' : 'OK';
                    } else {
                        tile.innerText = i === 0 ? 'IZQUIERDA' : 'DERECHA';
                        tile.onclick = () => stepP(i);
                    }
                    b.appendChild(tile);
                }
            } else { v.innerHTML = "<h3>ESPERA AL GUARDI√ÅN...</h3>"; }
        }

        function stepP(side) {
            let correctSide = currentBridgeMap[U.prog];
            let isBroken = (side !== correctSide);
            
            // Actualizar visuales para todos
            bridgeVisuals.push({ step: U.prog, side: side, broken: isBroken });
            db.ref('bridge_visuals').set(bridgeVisuals);

            if(isBroken) {
                db.ref('players/'+U.id).update({st:'DEAD'});
            } else {
                U.prog++;
                if(U.prog >= 12) { U.q = true; db.ref('players/'+U.id).update({q:true}); }
                render('PUENTE');
            }
        }

        function adminGame(g) {
            db.ref('state').update({ game: g });
            if(g === 'PUENTE') {
                // Generar camino secreto nuevo (12 pasos)
                let newMap = Array.from({length: 12}, () => Math.floor(Math.random() * 2));
                db.ref('bridge_map').set(newMap);
                db.ref('bridge_visuals').set([]);
            }
        }

        function reviveAll() { db.ref('players').once('value', s => s.forEach(c => db.ref('players/'+c.key+'/st').set('ALIVE'))); }
        if(U.role) route();
    </script>
</body>
</html>
