<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORION SQUID GAMES | ULTIMATE MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --pk: #ff2e63; --gr: #00ff41; --gd: #ffd700; --bk: #050505; --rd: #ff003c; --bl: #08d9d6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bk); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; min-height: 100vh; touch-action: manipulation; user-select: none; }
        
        .card { background: #111; border: 1px solid #333; border-radius: 12px; padding: 20px; max-width: 450px; margin: 0 auto 10px auto; box-shadow: 0 10px 30px #000; text-align: center; }
        .logo { font-size: 2rem; letter-spacing: 8px; text-shadow: 0 0 10px var(--pk); font-weight: 900; margin-bottom: 20px; }
        .btn-reset { position: fixed; right: 10px; top: 10px; background: #222; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; z-index: 9999; cursor: pointer; font-size: 1.2rem; }
        
        input, select { width: 100%; padding: 14px; margin-bottom: 10px; background: #000; color: white; border: 1px solid #444; border-radius: 8px; text-align: center; font-size: 1rem; }
        button { width: 100%; padding: 15px; margin: 5px 0; background: transparent; border: 2px solid var(--pk); color: var(--pk); font-weight: bold; border-radius: 8px; text-transform: uppercase; cursor: pointer; transition: 0.1s; }
        button:active { background: var(--pk); color: white; transform: scale(0.95); }
        
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .grid-3 button { padding: 12px 2px; font-size: 0.75rem; border-width: 1px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        .stats-row { display: flex; justify-content: space-between; background: #000; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; font-family: monospace; }
        
        /* Luz Roja */
        .luz { width: 80px; height: 80px; border-radius: 50%; margin: 15px auto; border: 4px solid #111; }
        .luz-verde { background: var(--gr); box-shadow: 0 0 40px var(--gr); }
        .luz-roja { background: var(--rd); box-shadow: 0 0 40px var(--rd); }
        .bar-bg { width: 100%; height: 20px; background: #222; border-radius: 10px; border: 1px solid #444; overflow: hidden; margin: 15px 0; }
        .bar-fill { height: 100%; background: var(--gr); width: 0%; transition: width 0.2s; }
        
        /* Dalgona */
        .dalgona-bar { width: 100%; height: 40px; background: #222; border-radius: 20px; position: relative; margin: 20px 0; border: 2px solid #444; overflow: hidden; }
        .dalgona-target { position: absolute; height: 100%; width: 20%; background: var(--gd); left: 40%; box-shadow: 0 0 10px var(--gd); }
        .dalgona-p { position: absolute; height: 100%; width: 4px; background: #fff; left: 0; box-shadow: 0 0 5px #fff; }
        
        /* Puente */
        .tile { height: 50px; border: 2px solid #444; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; }
        .tile.ok { border-color: var(--gr); background: rgba(0,255,0,0.2); color: var(--gr); }
        .tile.bad { border-color: var(--rd); background: rgba(255,0,0,0.2); color: var(--rd); }

        .view { display: none; }
        .active-view { display: block !important; }
        
        /* Chivato Admin */
        .admin-cheats { background: rgba(255, 215, 0, 0.1); border: 1px dashed var(--gd); padding: 10px; border-radius: 8px; margin-bottom: 10px; color: var(--gd); font-size: 0.85rem; text-align: left; }

        #toast { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background: #111; border: 1px solid var(--bl); padding: 12px 20px; border-radius: 8px; color: white; z-index: 10000; font-weight: bold; display: none; box-shadow: 0 5px 15px #000; }
    </style>
</head>
<body>

    <div id="toast">Notificaci√≥n</div>
    <div class="btn-reset" onclick="localStorage.clear(); location.reload();" title="Reiniciar Sesi√≥n">üîÑ</div>

    <div class="logo">üî∫‚ö™üü¶</div>

    <section id="v-login" class="card view active-view">
        <h3 style="margin-top:0;">INGRESO DE MAGOS</h3>
        <input type="text" id="user" placeholder="TU NOMBRE">
        <select id="house">
            <option value="Gryffindor">GRYFFINDOR</option>
            <option value="Slytherin">SLYTHERIN</option>
            <option value="Ravenclaw">RAVENCLAW</option>
            <option value="Hufflepuff">HUFFLEPUFF</option>
        </select>
        <button onpointerdown="login('PLAYER')" style="background:var(--pk); color:#fff;">ENTRAR A LA ARENA</button>
        <button onpointerdown="login('VIP')" style="border-color:var(--gd); color:var(--gd);">ESPECTADOR VIP</button>
        
        <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <input type="password" id="pass" placeholder="C√ìDIGO GUARDI√ÅN">
            <button onpointerdown="login('ADMIN')" style="border-color:var(--rd); color:var(--rd);">MANDO GUARDI√ÅN</button>
        </div>
    </section>

    <section id="v-player" class="card view">
        <div class="stats-row"><span id="p-n" style="color:var(--bl)">#000</span><span id="p-h">CASA</span><span id="p-s" style="color:var(--gr)">VIVO</span></div>
        <h2 id="p-title" style="color:var(--pk); margin: 5px 0;">ESPERA</h2>
        <div id="p-canvas" style="min-height: 200px;"></div>
    </section>

    <section id="v-admin" class="card view" style="border-color:var(--rd)">
        <h3 style="margin:0 0 10px 0; color:var(--rd);">üõ°Ô∏è PANEL DE CONTROL</h3>
        <div class="stats-row"><span>V: <b id="a-v">0</b></span><span>J: <b id="a-j" style="color:var(--pk)">ESPERA</b></span><span>M: <b id="a-m">0</b></span></div>
        
        <div class="admin-cheats"><b>INFO SECRETA:</b> <span id="a-cheats">Ninguna</span></div>

        <div id="a-luz" style="display:none; margin-bottom:10px;" class="grid-2">
            <button onpointerdown="dbSet('s/l', 'VERDE')" style="background:var(--gr); color:#000; border:none;">üü¢ VERDE</button>
            <button onpointerdown="dbSet('s/l', 'ROJO')" style="background:var(--rd); color:#fff; border:none;">üî¥ ROJA</button>
        </div>
        
        <div id="a-reflejos" style="display:none; margin-bottom:10px;">
            <button onpointerdown="attack()" style="background:var(--bl); color:#000;">‚ö° LANZAR ATAQUE SORPRESA</button>
        </div>

        <div class="grid-3">
            <button onpointerdown="setG('ESPERA')" style="border-color:#555; color:#aaa;">0. RESET</button>
            <button onpointerdown="setG('LUZ ROJA')">1. L. ROJA</button>
            <button onpointerdown="setG('DALGONA')">2. DALGONA</button>
            <button onpointerdown="setG('PUENTE')">3. PUENTE</button>
            <button onpointerdown="setG('TIPEO')">4. TIPEO</button>
            <button onpointerdown="setG('CANICAS')">5. CANICAS</button>
            <button onpointerdown="setG('RULETA')">6. RULETA</button>
            <button onpointerdown="setG('REFLEJOS')">7. REFLEJOS</button>
            <button onpointerdown="setG('FINAL')">8. C√ÅLIZ</button>
        </div>
        <div class="grid-2" style="margin-top:10px;">
            <button onpointerdown="killSlow()" style="border-color:var(--rd); color:var(--rd); font-size:0.75rem;">‚ò†Ô∏è ELIMINAR LENTOS</button>
            <button onpointerdown="reviveAll()" style="border-color:var(--gr); color:var(--gr); font-size:0.75rem;">‚ú® REVIVIR TODOS</button>
        </div>
    </section>

    <section id="v-vip" class="card view">
        <h2 id="v-title" style="color:var(--gd);">ZONA VIP</h2>
        <div class="stats-row" style="text-align:center; display:block; padding:15px; font-size:1.5rem;">
            VIVOS: <span id="v-v" style="color:var(--gr)">0</span> | MUERTOS: <span id="v-m" style="color:var(--rd)">0</span>
        </div>
        <p style="color:#888;">JUEGO: <span id="v-g" style="color:white; font-weight:bold;">...</span></p>
    </section>

    <script>
        const cfg = { databaseURL: "https://squid-games-24283-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(cfg); const db = firebase.database();
        
        let U = { id: localStorage.getItem('os_id'), role: localStorage.getItem('os_role'), st: 'ALIVE', prog: 0, q: false };
        let G = { name: "ESPERA", light: "ROJO", ans: null, atk: 0 };
        let bMap = [], bVis = []; 
        let dPos = 0, dDir = 1, dalInt;

        function notify(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none', 2000); }
        function switchView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view')); document.getElementById(id).classList.add('active-view'); }

        // --- INGRESO ---
        function login(role) {
            if(role === 'ADMIN') {
                if(document.getElementById('pass').value !== "SquidGamesOrion15") return notify("‚ùå PASSWORD INCORRECTO");
                U.role = 'ADMIN'; localStorage.setItem('os_role', 'ADMIN');
            } else {
                let name = document.getElementById('user').value.trim().toUpperCase();
                if(role === 'PLAYER' && name === "") return notify("‚ö†Ô∏è INGRESA TU NOMBRE");
                U.id = "u" + Date.now(); U.role = role;
                localStorage.setItem('os_id', U.id); localStorage.setItem('os_role', role);
                if(role === 'PLAYER') db.ref('p/'+U.id).set({ n: name, h: document.getElementById('house').value, st: 'ALIVE', q: false, num: Math.floor(Math.random()*456+1) });
            }
            route();
        }

        function route() {
            if(!U.role) return switchView('v-login');
            if(U.role === 'ADMIN') { switchView('v-admin'); initAdmin(); }
            else if(U.role === 'VIP' || U.st === 'DEAD') { 
                switchView('v-vip'); 
                if(U.st==='DEAD') { document.getElementById('v-vip').style.borderColor='var(--rd)'; document.getElementById('v-title').innerText="EL PURGATORIO"; document.getElementById('v-title').style.color='var(--rd)'; }
                initVIP(); 
            } else { switchView('v-player'); initPlayer(); }
        }

        // --- ADMIN ---
        function initAdmin() {
            db.ref('p').on('value', s => { let a=0, d=0; s.forEach(c => { if(c.val().st==='ALIVE') a++; else d++; }); document.getElementById('a-v').innerText=a; document.getElementById('a-m').innerText=d; });
            db.ref('b_m').on('value', s => bMap = s.val() || []);
            
            db.ref('s').on('value', snap => {
                let s = snap.val() || {g:'ESPERA', l:'ROJO', ans:null};
                document.getElementById('a-j').innerText = s.g;
                document.getElementById('a-luz').style.display = (s.g === 'LUZ ROJA') ? 'grid' : 'none';
                document.getElementById('a-reflejos').style.display = (s.g === 'REFLEJOS') ? 'block' : 'none';
                
                // CHIVATO ACTUALIZADO
                let cheat = "Ninguna";
                if(s.g === 'PUENTE') cheat = bMap.map(x=>x===0?'IZQ':'DER').join(' > ');
                else if(s.g === 'CANICAS' && s.ans) cheat = s.ans.map(x=>x===0?'PAR':'IMPAR').join(' - ');
                else if(s.g === 'RULETA' && s.ans !== null) cheat = "Disparo letal en el clic n√∫mero " + (s.ans + 1);
                else if(s.g === 'TIPEO') cheat = "EXPECTO PATRONUM";
                else if(s.g === 'DALGONA') cheat = "Deben acertar 3 niveles de velocidad creciente.";
                document.getElementById('a-cheats').innerText = cheat;
            });
        }

        function setG(g) {
            let sData = { g: g, l: 'ROJO', ans: null, atk: 0 };
            if(g === 'PUENTE') { db.ref('b_m').set(Array.from({length: 10}, () => Math.floor(Math.random() * 2))); db.ref('b_v').set([]); }
            if(g === 'CANICAS') sData.ans = [Math.floor(Math.random()*2), Math.floor(Math.random()*2), Math.floor(Math.random()*2)];
            if(g === 'RULETA') sData.ans = Math.floor(Math.random()*6); // 0 a 5
            db.ref('s').update(sData); notify("üéÆ JUEGO: " + g);
        }
        function attack() { db.ref('s/atk').set(Date.now()); notify("‚ö° ATAQUE LANZADO"); }
        function dbSet(p, v) { db.ref(p).set(v); }
        function killSlow() { db.ref('p').once('value', s => s.forEach(c => { if(c.val().st==='ALIVE' && !c.val().q) db.ref('p/'+c.key+'/st').set('DEAD'); })); notify("‚ò†Ô∏è LENTOS ELIMINADOS"); }
        function reviveAll() { db.ref('p').once('value', s => s.forEach(c => db.ref('p/'+c.key+'/st').set('ALIVE'))); notify("‚ú® REVIVIDOS"); }

        // --- VIP ---
        function initVIP() {
            db.ref('s/g').on('value', s => document.getElementById('v-g').innerText = s.val());
            db.ref('p').on('value', s => { let a=0, d=0; s.forEach(c => { if(c.val().st==='ALIVE') a++; else d++; }); document.getElementById('v-v').innerText=a; document.getElementById('v-m').innerText=d; });
        }

        // --- JUGADOR ---
        function initPlayer() {
            db.ref('s').on('value', snap => {
                const s = snap.val() || {g:'ESPERA', l:'ROJO', ans:null, atk:0};
                if(window.lg !== s.g) { U.prog = 0; U.q = false; window.lg = s.g; clearInterval(dalInt); db.ref('p/'+U.id+'/q').set(false); }
                G = s; renderUI();
            });
            db.ref('b_v').on('value', s => { bVis = s.val() || []; if(G.name === 'PUENTE') renderUI(); });
            db.ref('p/'+U.id).on('value', s => { 
                if(!s.val()) return; U.st = s.val().st; 
                document.getElementById('p-n').innerText = "#" + s.val().num; document.getElementById('p-h').innerText = s.val().h;
                if(U.st === 'DEAD') route(); 
            });
        }

        function renderUI() {
            if(U.st === 'DEAD') return;
            const v = document.getElementById('p-canvas'); document.getElementById('p-title').innerText = G.g;
            if(U.q) { v.innerHTML = "<h2 style='color:var(--gd); margin-top:30px;'>CALIFICADO</h2>"; return; }

            switch(G.g) {
                case 'LUZ ROJA':
                    v.innerHTML = `<div class="luz ${G.l==='VERDE'?'luz-verde':'luz-roja'}"></div><div class="bar-bg"><div class="bar-fill" style="width:${U.prog}%"></div></div><button onpointerdown="actL()">AVANZAR</button>`;
                    break;
                case 'DALGONA':
                    v.innerHTML = `<p>NIVEL: ${U.prog+1}/3</p><div class="dalgona-bar"><div class="dalgona-target"></div><div id="dp" class="dalgona-p"></div></div><button onpointerdown="actD()">¬°CORTAR!</button>`;
                    if(!dalInt) startDal();
                    break;
                case 'PUENTE':
                    v.innerHTML = `<p>PASO: ${U.prog}/10</p><div class="grid-2" id="br"></div>`;
                    for(let i=0; i<2; i++) {
                        let d = document.createElement('div'); d.className = 'tile';
                        let h = bVis.find(x => x.s === U.prog && x.side === i);
                        if(h) { d.className += h.ok ? ' ok' : ' bad'; d.innerText = h.ok ? 'OK' : 'X'; }
                        else { d.innerText = i===0?'IZQ':'DER'; d.onpointerdown = () => actP(i); }
                        document.getElementById('br').appendChild(d);
                    }
                    break;
                case 'TIPEO':
                    v.innerHTML = `<p>Escribe: EXPECTO PATRONUM</p><input id="ti" autocomplete="off"><button onpointerdown="actT()">LANZAR</button>`;
                    break;
                case 'CANICAS':
                    v.innerHTML = `<p>RONDA ${U.prog+1}/3. ¬øPAR O IMPAR?</p><div class="grid-2"><button onpointerdown="actC(0)">PAR</button><button onpointerdown="actC(1)">IMPAR</button></div>`;
                    break;
                case 'RULETA':
                    v.innerHTML = `<p>GATILLO ${U.prog+1}/5</p><button onpointerdown="actR()" style="height:100px; font-size:1.5rem; color:var(--rd); border-color:var(--rd);">üî´ DISPARAR</button>`;
                    break;
                case 'REFLEJOS':
                    if(G.atk > window.lastAtk) {
                        v.innerHTML = `<button onpointerdown="win()" style="height:150px; font-size:2rem; background:var(--bl); color:black;">üõ°Ô∏è ¬°PROTEGO!</button>`;
                        window.atkTimer = setTimeout(() => { if(!U.q) die(); }, 1500); // Tienen 1.5s para tocar
                        window.lastAtk = G.atk;
                    } else { v.innerHTML = "<h3 style='color:var(--pk); margin-top:40px;'>ATENTO...</h3>"; }
                    break;
                case 'FINAL':
                    v.innerHTML = `<p>No levantes el dedo.</p><button id="btn-c" style="height:120px; border-color:var(--gd); color:var(--gd); touch-action:none;">üèÜ MANTENER</button>`;
                    const bC = document.getElementById('btn-c'); bC.onpointerdown = () => bC.style.background='var(--gd)'; bC.onpointerup = die; bC.onpointerleave = die;
                    break;
                default:
                    v.innerHTML = "<h3>SALA DE ESPERA</h3>";
            }
        }

        // --- L√ìGICAS JUGADOR ---
        function die() { db.ref('p/'+U.id).update({st:'DEAD'}); }
        function win() { U.q = true; db.ref('p/'+U.id).update({q:true}); clearInterval(dalInt); renderUI(); }

        function actL() { if(G.l==='ROJO') die(); else { U.prog+=5; if(U.prog>=100) win(); else renderUI(); } }
        
        function startDal() {
            clearInterval(dalInt); let sp = 30 - (U.prog * 8); // Se vuelve m√°s r√°pido
            dalInt = setInterval(() => { dPos += (3 * dDir); if(dPos >= 90 || dPos <= 0) dDir *= -1; let p = document.getElementById('dp'); if(p) p.style.left = dPos + "%"; }, sp);
        }
        function actD() { clearInterval(dalInt); if(dPos >= 40 && dPos <= 60) { U.prog++; if(U.prog >= 3) win(); else { notify("¬°BIEN! M√ÅS R√ÅPIDO..."); dalInt=0; renderUI(); } } else die(); }
        
        function actP(i) { let ok = (i === G.ans[U.prog]); bVis.push({s: U.prog, side: i, ok: ok}); db.ref('b_v').set(bVis); if(!ok) die(); else { U.prog++; if(U.prog>=10) win(); else renderUI(); } }
        
        function actT() { if(document.getElementById('ti').value.trim().toUpperCase() === "EXPECTO PATRONUM") win(); else die(); }
        
        function actC(guess) { if(guess === G.ans[U.prog]) { U.prog++; if(U.prog>=3) win(); else renderUI(); } else die(); }
        
        function actR() { if(U.prog === G.ans) die(); else { U.prog++; if(U.prog>=5) win(); else renderUI(); } }

        window.onload = () => { window.lastAtk = 0; if(U.role) route(); };
    </script>
</body>
</html>
